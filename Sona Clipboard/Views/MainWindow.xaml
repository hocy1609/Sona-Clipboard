<Window
    x:Class="Sona_Clipboard.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:Sona_Clipboard.Views"
    xmlns:models="using:Sona_Clipboard.Models"
    xmlns:converters="using:Sona_Clipboard.Converters"
    xmlns:tb="using:H.NotifyIcon"
    mc:Ignorable="d">

    <Window.SystemBackdrop>
        <MicaBackdrop Kind="Base"/>
    </Window.SystemBackdrop>

    <Grid>
        <Grid.Resources>
            <converters:TypeToIconConverter x:Key="TypeToIconConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" Inverse="False"/>
            <converters:BoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" Inverse="True"/>
        </Grid.Resources>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid>
            <tb:TaskbarIcon 
                x:Name="TrayIcon"
                IconSource="/favicon.ico"
                ToolTipText="Sona Clipboard"
                DoubleClickCommand="{Binding ShowWindowCommand}"
                LeftClickCommand="{Binding ShowWindowCommand}"
                >
                <!-- LeftClickCommand added as backup/alternative to DoubleClick -->

                <tb:TaskbarIcon.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ" Command="{Binding ShowWindowCommand}" />
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem Text="Ð’Ñ‹Ñ…Ð¾Ð´" Command="{Binding ExitAppCommand}" />
                    </MenuFlyout>
                </tb:TaskbarIcon.ContextFlyout>
            </tb:TaskbarIcon>

        </Grid>

        <Grid x:Name="AppTitleBar" Height="40" Background="Transparent" Padding="15,0">
            <TextBlock Text="Sona Clipboard" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold"/>
        </Grid>

        <Grid Grid.Row="1" Padding="20">

            <Grid x:Name="HistoryView" Visibility="Visible">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="SearchBox" PlaceholderText="ÐŸÐ¾Ð¸ÑÐº..." TextChanged="SearchBox_TextChanged"/>
                    <CheckBox x:Name="ArchiveSearchCheck" Content="Ð’ Ð°Ñ€Ñ…Ð¸Ð²Ðµ" Grid.Column="1" Margin="10,0,0,0" 
                              Checked="ArchiveSearchCheck_Changed" Unchecked="ArchiveSearchCheck_Changed"
                              VerticalAlignment="Center" FontSize="12"/>
                    <Button x:Name="SettingsButton" Content="&#xE713;" FontFamily="Segoe MDL2 Assets" 
                            Grid.Column="2" Margin="10,0,0,0" Click="SettingsButton_Click"/>
                </Grid>

                <ListView x:Name="ClipboardList" Grid.Row="1" SelectionMode="None" IsItemClickEnabled="True" ItemClick="ClipboardList_ItemClick">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid Padding="10" CornerRadius="4" Margin="0,4" Background="#0AFFFFFF">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <FontIcon Glyph="{Binding Type, Converter={StaticResource TypeToIconConverter}}" 
                                          FontFamily="Segoe MDL2 Assets" Margin="0,0,15,0" Opacity="0.6"/>

                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding DisplayText}" TextTrimming="CharacterEllipsis" MaxLines="1" FontWeight="Medium"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="{Binding Timestamp}" FontSize="10" Opacity="0.5"/>
                                        <TextBlock Text="{Binding SourceAppName}" FontSize="10" Opacity="0.5" Foreground="LightSkyBlue"/>
                                        <TextBlock Text="ðŸ“Œ Ð—Ð°ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¾" FontSize="10" Foreground="Gold" 
                                                   Visibility="{Binding IsPinned, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    </StackPanel>
                                </StackPanel>

                                <Image Source="{Binding Thumbnail}" Grid.Column="2" Height="30" Width="40" Stretch="Uniform" Margin="10,0,0,0"
                                       PointerEntered="Thumbnail_PointerEntered">
                                    <ToolTipService.ToolTip>
                                        <ToolTip DataContext="{Binding}" Opened="ThumbnailToolTip_Opened">
                                            <Image x:Name="PreviewTooltipImage" MaxWidth="320" MaxHeight="240" Stretch="Uniform"/>
                                        </ToolTip>
                                    </ToolTipService.ToolTip>
                                </Image>

                                <StackPanel Grid.Column="3" Orientation="Horizontal" Margin="10,0,0,0" Spacing="4">
                                    <Button Content="ðŸ“‹" Padding="4"
                                            Click="CopyButton_Click" ToolTipService.ToolTip="Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"/>
                                    <Button Content="ðŸ“Œ" Padding="4" 
                                            Click="PinButton_Click" ToolTipService.ToolTip="Ð—Ð°ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ/ÐžÑ‚ÐºÑ€ÐµÐ¿Ð¸Ñ‚ÑŒ"/>
                                    <Button Content="ðŸ—‘ï¸" Foreground="Red" Padding="4"
                                            Click="DeleteButton_Click" ToolTipService.ToolTip="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ"
                                            Visibility="{Binding IsPinned, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <TextBlock x:Name="EmptyStatusText" Grid.Row="1" Text="Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿ÑƒÑÑ‚Ð°" 
                           HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.5" Visibility="Collapsed"/>
            </Grid>


            <Grid x:Name="SettingsView" Visibility="Collapsed">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Button x:Name="BackButton" Content="ÐÐ°Ð·Ð°Ð´" Click="BackButton_Click" Margin="0,0,0,15"/>

                <ScrollViewer Grid.Row="1">
                    <StackPanel Spacing="15">
                        <TextBlock Text="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸" FontSize="20" FontWeight="Bold"/>

                        <Border Background="#0FFFFFFF" CornerRadius="8" Padding="15">
                            <StackPanel Spacing="10">
                                <TextBlock Text="ÐžÐ±Ñ‰Ð¸Ðµ" FontWeight="Bold"/>
                                <ToggleSwitch x:Name="AutoStartToggle" Header="Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ Windows" 
                                              Toggled="AutoStartToggle_Toggled" IsOn="False"/>
                                
                                <ToggleSwitch x:Name="RunAsAdminToggle" Header="Ð ÐµÐ¶Ð¸Ð¼ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°" 
                                              Toggled="RunAsAdminToggle_Toggled" IsOn="False"/>
                                <TextBlock Text="* ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÑ…Ð²Ð°Ñ‚Ð° Ð³Ð¾Ñ€ÑÑ‡Ð¸Ñ… ÐºÐ»Ð°Ð²Ð¸Ñˆ Ð¸Ð· Admin-Ð¾ÐºÐ¾Ð½" 
                                           FontSize="10" Opacity="0.5" TextWrapping="Wrap"/>
                                <TextBlock Text="Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…" FontWeight="Bold" Margin="0,10,0,0"/>
                                <TextBlock x:Name="DbPathText" TextWrapping="Wrap" Opacity="0.7" FontSize="11"/>
                                <Button Content="ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ð°Ð¿ÐºÑƒ" Click="OpenFolder_Click"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#0FFFFFFF" CornerRadius="8" Padding="15">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Ð“Ð¾Ñ€ÑÑ‡Ð¸Ðµ ÐºÐ»Ð°Ð²Ð¸ÑˆÐ¸" FontWeight="Bold"/>

                                <TextBlock Text="ÐŸÑ€ÐµÐ´. ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ (Ð’Ð²ÐµÑ€Ñ…):" Opacity="0.7" Margin="0,10,0,0"/>
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <CheckBox x:Name="HkNextCtrl" Content="Ctrl"/>
                                    <CheckBox x:Name="HkNextShift" Content="Shift"/>
                                    <CheckBox x:Name="HkNextAlt" Content="Alt"/>
                                    <ComboBox x:Name="HkNextKey" SelectedIndex="22" Width="80">
                                        <x:String>A</x:String>
                                        <x:String>B</x:String>
                                        <x:String>C</x:String>
                                        <x:String>D</x:String>
                                        <x:String>E</x:String>
                                        <x:String>F</x:String>
                                        <x:String>G</x:String>
                                        <x:String>H</x:String>
                                        <x:String>I</x:String>
                                        <x:String>J</x:String>
                                        <x:String>K</x:String>
                                        <x:String>L</x:String>
                                        <x:String>M</x:String>
                                        <x:String>N</x:String>
                                        <x:String>O</x:String>
                                        <x:String>P</x:String>
                                        <x:String>Q</x:String>
                                        <x:String>R</x:String>
                                        <x:String>S</x:String>
                                        <x:String>T</x:String>
                                        <x:String>U</x:String>
                                        <x:String>V</x:String>
                                        <x:String>W</x:String>
                                        <x:String>X</x:String>
                                        <x:String>Y</x:String>
                                        <x:String>Z</x:String>
                                    </ComboBox>
                                </StackPanel>

                                <TextBlock Text="Ð¡Ð»ÐµÐ´. ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ (Ð’Ð½Ð¸Ð·):" Opacity="0.7" Margin="0,10,0,0"/>
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <CheckBox x:Name="HkPrevCtrl" Content="Ctrl"/>
                                    <CheckBox x:Name="HkPrevShift" Content="Shift"/>
                                    <CheckBox x:Name="HkPrevAlt" Content="Alt"/>
                                    <ComboBox x:Name="HkPrevKey" SelectedIndex="18" Width="80">
                                        <x:String>A</x:String>
                                        <x:String>B</x:String>
                                        <x:String>C</x:String>
                                        <x:String>D</x:String>
                                        <x:String>E</x:String>
                                        <x:String>F</x:String>
                                        <x:String>G</x:String>
                                        <x:String>H</x:String>
                                        <x:String>I</x:String>
                                        <x:String>J</x:String>
                                        <x:String>K</x:String>
                                        <x:String>L</x:String>
                                        <x:String>M</x:String>
                                        <x:String>N</x:String>
                                        <x:String>O</x:String>
                                        <x:String>P</x:String>
                                        <x:String>Q</x:String>
                                        <x:String>R</x:String>
                                        <x:String>S</x:String>
                                        <x:String>T</x:String>
                                        <x:String>U</x:String>
                                        <x:String>V</x:String>
                                        <x:String>W</x:String>
                                        <x:String>X</x:String>
                                        <x:String>Y</x:String>
                                        <x:String>Z</x:String>
                                    </ComboBox>
                                </StackPanel>

                                <Button Content="ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÐºÐ»Ð°Ð²Ð¸ÑˆÐ¸" Click="ApplyHotKeys_Click"/>
                                <TextBlock x:Name="HotKeyStatusText" FontSize="12" Opacity="0.7" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#0FFFFFFF" CornerRadius="8" Padding="15">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ðµ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ" FontWeight="Bold"/>
                                <TextBlock x:Name="DbHealthText" Text="Ð Ð°Ð·Ð¼ÐµÑ€ Ð‘Ð”: 0 MB" Opacity="0.7" FontSize="12"/>
                                
                                <PasswordBox x:Name="BackupPasswordBox" PlaceholderText="ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ ÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)" 
                                         Header="Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð±ÑÐºÐ°Ð¿Ð°" FontSize="12"/>
                                
                                <Grid ColumnSpacing="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Button Content="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿" Click="CreateBackup_Click" HorizontalAlignment="Stretch"/>
                                    <Button Content="Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" Click="RestoreBackup_Click" Grid.Column="1" HorizontalAlignment="Stretch"/>
                                </Grid>
                                
                                <TextBlock Text="ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸: Ð¥Ñ€Ð°Ð½Ð¸Ð¼ 5 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… ÐºÐ¾Ð¿Ð¸Ð¹" FontSize="10" Opacity="0.5"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#0FFFFFFF" CornerRadius="8" Padding="15">
                            <StackPanel Spacing="10">
                                <TextBlock Text="ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ" FontWeight="Bold"/>
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <TextBox x:Name="HistoryLimitBox" Text="10.0" Width="60"/>
                                    <TextBlock Text="GB" VerticalAlignment="Center" Opacity="0.7"/>
                                    <Button Content="ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð»Ð¸Ð¼Ð¸Ñ‚" Click="ApplyLimit_Click"/>
                                </StackPanel>
                                <Button Content="ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð‘Ð” (Vacuum)" Click="OptimizeDb_Click" HorizontalAlignment="Stretch"/>
                                <Button Content="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹" Click="RemoveDuplicates_Click" HorizontalAlignment="Stretch"/>
                                <Button Content="ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ" Foreground="Red" Click="ClearHistory_Click" HorizontalAlignment="Stretch"/>
                                
                                <TextBlock Text="ÐŸÐ¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼" FontWeight="Bold" Margin="0,10,0,0"/>
                                <ItemsControl x:Name="AppStatsList">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,5">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="{Binding Key}" VerticalAlignment="Center" FontSize="12"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Value}" Opacity="0.5" Margin="10,0" VerticalAlignment="Center" FontSize="12"/>
                                                <Button Grid.Column="2" Content="ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ" Click="DeleteByApp_Click" Tag="{Binding Key}" Padding="8,2" FontSize="12"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <TextBlock x:Name="MaintenanceStatus" Foreground="LimeGreen" FontSize="12"/>
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</Window>
